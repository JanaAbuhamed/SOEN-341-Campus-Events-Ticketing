{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Tickets</title>
  <link rel="stylesheet" href="{% static 'css/studentdashboard.css' %}">
  <link rel="stylesheet" href="{% static 'css/studentcalendar.css' %}">
</head>
<body>
  

  <main class="tickets-wrap">
    <div class="toolbar">
      <a class="btn" href="{% url 'eventlist' %}">Browse Events</a>
      <a class="btn secondary" href="{% url 'update_profile' %}">Edit Profile</a>
      <a class="btn secondary" href="{% url 'update_password' %}">Change Password</a>
      <button id="clearBtn" class="btn secondary">Clear All (dev)</button>
    </div>

    <div id="ticketsGrid" class="grid"></div>

    <div id="emptyState" class="empty hidden">
      <img src="https://cdn-icons-png.flaticon.com/512/748/748113.png" alt="No Tickets" />
      <h3>No tickets yet</h3>
      <p>Claim an event from Upcoming Events to see your QR here.</p>
      <a class="btn" href="{% url 'eventlist' %}">Find Events</a>
    </div>

    <!-- üóìÔ∏è Upcoming Events Calendar -->
    <section class="calendar-section">
      <h2 style="text-align:center; margin: 50px 0 20px;">üìÖ Upcoming Events Calendar</h2>

      <div class="calendar-container">
        <div class="calendar-card">
          <div class="calendar-header">
            <button id="prev-month">‚Üê</button>
            <div>
              <h1 id="month" class="month-name"></h1>
              <p id="year" class="year"></p>
            </div>
            <button id="next-month">‚Üí</button>
          </div>

          <div class="calendar-weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div>
            <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>

          <div id="calendar-days" class="calendar-days"></div>

          <div class="calendar-footer">
            <p id="today-text"></p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- QR Dialog -->
  <dialog id="qrDialog">
    <div class="dialog-body">
      <button type="button" id="dlgClose" class="close" aria-label="Close">&times;</button>
      <h3 id="dlgTitle"></h3>
      <div id="dlgQR" class="qr-large"></div>
      <div class="modal-actions">
        <button id="dlgDownload" class="btn" type="button">Download PNG</button>
      </div>
    </div>
  </dialog>

  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="{% static 'js/studentdashboard.js' %}"></script>

  <script>
    // ‚úÖ Load event data from backend
    const events = [
      {% for e in events %}
        {
          title: "{{ e.title|escapejs }}",
          date: "{{ e.date|date:'Y-m-d' }}",
          time: "{{ e.time }}",
          location: "{{ e.location|escapejs }}"
        },
      {% endfor %}
    ];
    console.log("Loaded events:", events);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // ‚úÖ Moved JS inside DOMContentLoaded so it waits for HTML
      const monthEl = document.getElementById("month");
      const yearEl = document.getElementById("year");
      const daysEl = document.getElementById("calendar-days");
      const todayText = document.getElementById("today-text");

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      let currentDate = new Date();
      const today = new Date();

      function renderCalendar() {
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();

        monthEl.textContent = months[month];
        yearEl.textContent = year;
        daysEl.innerHTML = "";

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const prevLastDay = new Date(year, month, 0).getDate();

        const firstDayIndex = firstDayOfMonth.getDay();
        const lastDayIndex = lastDayOfMonth.getDay();
        const nextDays = 6 - lastDayIndex;

        // Previous month days
        for (let x = firstDayIndex; x > 0; x--) {
          const div = document.createElement("div");
          div.textContent = prevLastDay - x + 1;
          div.classList.add("inactive");
          daysEl.appendChild(div);
        }

        // Current month days
        for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
          const div = document.createElement("div");
          div.textContent = i;

          // Highlight today
          if (
            i === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
          ) {
            div.classList.add("today");
          }

          // Highlight event days
          const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          events.forEach(event => {
            if (event.date === dateString) {
              div.classList.add("event-day");
              div.title = `${event.title} (${event.time})`;
            }
          });

          daysEl.appendChild(div);
        }

        // Next month days
        for (let j = 1; j <= nextDays; j++) {
          const div = document.createElement("div");
          div.textContent = j;
          div.classList.add("inactive");
          daysEl.appendChild(div);
        }

        todayText.textContent = `Today is ${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
      }

      document.getElementById("prev-month").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });

      document.getElementById("next-month").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      renderCalendar();
    });
  </script>
</body>
</html>
